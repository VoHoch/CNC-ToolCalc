# Change Request: Phase 1 - Frontend Project Setup & State Management

**CR-ID:** CR-2025-11-11-002
**Version:** v0.0.1-alpha ‚Üí v0.1.0-alpha
**Agent:** frontend-workflow
**Status:** DRAFT
**Created:** 2025-11-11
**Updated:** 2025-11-11

---

## Summary

Set up the React + TypeScript + Vite frontend project with state management (Zustand), API client (React Query), and routing foundation. Prepare for 6-screen workflow implementation.

---

## Type

- [x] Feature (new functionality)
- [ ] Enhancement
- [ ] Bug Fix
- [ ] Refactoring
- [ ] Documentation
- [ ] Test

---

## Motivation

Before implementing the 6-screen workflow, we need:
1. A working React project with modern tooling
2. Type-safe state management for complex tool/material selections
3. API client for backend communication
4. Routing infrastructure for screen navigation
5. Development tools (hot reload, linting, testing)

This CR establishes the technical foundation that makes screen implementation efficient and type-safe.

---

## Detailed Description

### 1. Project Scaffolding
- Initialize Vite + React + TypeScript project
- Configure ESLint + Prettier
- Set up path aliases (`@/components`, `@/stores`, etc.)
- Configure Vitest (testing)

### 2. State Management (Zustand)
Create 3 stores:

**a) toolStore.ts**
- Selected tools: `Tool[]`
- Tool-specific materials: `Record<string, MaterialType>`
- Tool library: `Tool[]`
- Import/export tool library

**b) calculationStore.ts**
- Current calculation inputs
- Calculation results
- Expert mode state (global slider, overrides)
- Calculation history

**c) uiStore.ts**
- Current screen (1-6)
- Contrast mode (medium/balanced/high)
- Sidebar collapsed state
- Loading states

### 3. API Client (React Query)
Set up API client with:
- Base URL configuration
- TypeScript types (from API Contract)
- Query hooks:
  - `useImportTools()`
  - `useMaterials()`
  - `useOperations()`
  - `useCalculate()`
  - `useExportFusion()`
  - `useExportCSV()`
- Error handling
- Loading states
- Caching strategy

### 4. Routing (React Router)
Define 6 routes:
```
/                  ‚Üí Tool Selection
/materials         ‚Üí Material Selection (per tool)
/operations        ‚Üí Operation Selection
/parameters        ‚Üí Parameter Configuration
/results           ‚Üí Results Display
/export            ‚Üí Export Options
```

### 5. Type Definitions
Create TypeScript types matching API Contract:
- `Tool`, `ToolGeometry`
- `Material`, `MaterialType`
- `Operation`, `OperationType`
- `CalculationRequest`, `CalculationResponse`
- `ExpertModeConfig`
- `CoatingType`, `SurfaceQuality`, `CoolantType`

---

## Implementation Details

### Files Created (NEW)

**Project Config:**
```
frontend/
‚îú‚îÄ‚îÄ vite.config.ts              (50 lines)
‚îú‚îÄ‚îÄ tsconfig.json               (40 lines)
‚îú‚îÄ‚îÄ .eslintrc.json              (30 lines)
‚îú‚îÄ‚îÄ .prettierrc                 (10 lines)
‚îî‚îÄ‚îÄ vitest.config.ts            (30 lines)
```

**State Management:**
```
frontend/src/stores/
‚îú‚îÄ‚îÄ toolStore.ts                (150 lines)
‚îú‚îÄ‚îÄ calculationStore.ts         (200 lines)
‚îú‚îÄ‚îÄ uiStore.ts                  (80 lines)
‚îî‚îÄ‚îÄ index.ts                    (20 lines)
```

**API Client:**
```
frontend/src/api/
‚îú‚îÄ‚îÄ client.ts                   (100 lines)
‚îú‚îÄ‚îÄ queries.ts                  (200 lines)
‚îú‚îÄ‚îÄ mutations.ts                (150 lines)
‚îî‚îÄ‚îÄ types.ts                    (300 lines)
```

**Routing:**
```
frontend/src/
‚îú‚îÄ‚îÄ App.tsx                     (80 lines)
‚îú‚îÄ‚îÄ routes.tsx                  (60 lines)
‚îî‚îÄ‚îÄ screens/
    ‚îú‚îÄ‚îÄ ToolSelection.tsx       (50 lines - placeholder)
    ‚îú‚îÄ‚îÄ MaterialSelection.tsx   (50 lines - placeholder)
    ‚îú‚îÄ‚îÄ OperationSelection.tsx  (50 lines - placeholder)
    ‚îú‚îÄ‚îÄ ParameterConfig.tsx     (50 lines - placeholder)
    ‚îú‚îÄ‚îÄ Results.tsx             (50 lines - placeholder)
    ‚îî‚îÄ‚îÄ Export.tsx              (50 lines - placeholder)
```

**Total Estimated Lines:** ~1,800 lines

### Dependencies

**New packages:**
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.20.0",
    "zustand": "^4.4.7",
    "@tanstack/react-query": "^5.14.0",
    "axios": "^1.6.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.0",
    "vite": "^5.0.0",
    "typescript": "^5.3.0",
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.1.0",
    "@testing-library/jest-dom": "^6.1.0",
    "eslint": "^8.55.0",
    "prettier": "^3.1.0"
  }
}
```

---

## Architecture Compliance

- [x] Follows Cleanroom principle (no V2.0 code)
- [x] Implements Architecture specifications
  - Reference: `docs/architecture/CNC_CALCULATOR_V4_FINAL_ARCHITECTURE_CONSOLIDATED.md` (Part 4)
- [x] API Contract adhered to
  - Reference: `docs/contracts/API_CONTRACT.md`
- [x] Material selection **PER TOOL** (not global)
  - Store: `Record<toolId, materialId>` ‚úì
- [x] TypeScript strict mode enabled
- [x] Path aliases for clean imports

---

## Testing

### Unit Tests
- [ ] toolStore: 20 tests (tool selection, material per tool)
- [ ] calculationStore: 25 tests (calculations, expert mode)
- [ ] uiStore: 15 tests (screen navigation, UI state)
- [ ] API client: 20 tests (queries, mutations, errors)
- [ ] **Total:** 80 tests
- [ ] **Coverage Target:** >90%

### Integration Tests
- [ ] Store persistence (localStorage)
- [ ] API client ‚Üí Backend integration
- [ ] Routing navigation
- [ ] State synchronization

### Smoke Test
```bash
#!/bin/bash
# Smoke Test: Frontend Foundation

echo "üß™ Starting Smoke Test: CR-2025-11-11-002"

# Check if project builds
npm run build || exit 1

# Check if dev server starts
timeout 10s npm run dev || exit 1

# Check store files exist
[ -f "frontend/src/stores/toolStore.ts" ] || exit 1
[ -f "frontend/src/stores/calculationStore.ts" ] || exit 1

# Check API client exists
[ -f "frontend/src/api/client.ts" ] || exit 1

# Run unit tests
npm run test || exit 1

echo "‚úÖ Smoke Test PASSED"
```

**Smoke Test Script:** `scripts/smoke-test-cr-002.sh`

---

## Quality Audit

### Code Quality
- [ ] TypeScript: 100% type coverage (no `any`)
- [ ] ESLint: 0 errors
- [ ] Prettier: Code formatted
- [ ] Store complexity <15
- [ ] API client error handling complete

### Performance
- [ ] Bundle size <500KB (before code splitting)
- [ ] Initial load time <2s
- [ ] State updates <16ms

### Security
- [ ] API keys not in code (env vars)
- [ ] Input validation on forms
- [ ] XSS protection (React default)

---

## User Acceptance Test (UAT)

**UAT Test Plan:**
1. Start dev server: `npm run dev`
2. Verify app loads at `http://localhost:5173/`
3. Test routing:
   - Navigate to `/materials` ‚úì
   - Navigate to `/operations` ‚úì
   - Back button works ‚úì
4. Test state management:
   - Open DevTools
   - Check Zustand stores initialized ‚úì
   - Modify toolStore state ‚úì
   - Verify persistence (refresh page) ‚úì
5. Test API client:
   - Mock backend call
   - Verify loading state ‚úì
   - Verify error handling ‚úì

**UAT Results:**
- [ ] UAT completed by: [User Name]
- [ ] UAT date: YYYY-MM-DD
- [ ] UAT status: [PASSED / FAILED]

---

## Rollback Plan

```bash
# Revert changes
git revert <commit-hash>

# OR restore from backup
git checkout v0.0.1-alpha -- frontend/
```

---

## Related Change Requests

- **Depends on:** CR-2025-11-11-001 (needs UI components)
- **Blocks:** Phase 2 screen implementations
- **Related:** CR-2025-11-11-003 (Backend API must match types)

---

## Approval

- [ ] Agent self-review completed
- [ ] Governance Agent review completed
- [ ] Smoke test passed
- [ ] UAT passed
- [ ] Ready for merge

**Approved by:** [Pending]
**Date:** [Pending]

---

## Post-Merge

- [ ] Merged to `agent/frontend-workflow`
- [ ] Governance reviewed
- [ ] Quality Gate 1 passed
- [ ] Tagged: `v0.1.0-alpha` (after all Phase 1 CRs)
- [ ] Documentation updated

---

## Agent Notes

**Critical Requirements:**
1. **Material selection MUST be per tool** - `toolMaterials: Record<toolId, materialId>`
2. **Expert Mode state** - Global slider + per-parameter overrides
3. **Type safety** - All API types must match `API_CONTRACT.md`
4. **State persistence** - Use localStorage for toolStore

**Material Selection Logic:**
```typescript
// ‚úÖ CORRECT - Material per tool
const toolMaterials: Record<string, MaterialType> = {
  "T1": "ALUMINIUM",
  "T2": "STEEL_MILD",
  "T3": "ALUMINIUM",
};

// ‚ùå WRONG - Global material (V3.x mistake)
const selectedMaterial: MaterialType = "ALUMINIUM";
```

**Expert Mode State:**
```typescript
interface ExpertModeState {
  enabled: boolean;
  globalSlider: number;        // -50 to +50
  overrides?: {
    ae_mm?: number;            // Override for specific tool
    ap_mm?: number;
    fz_mm?: number;
  };
}
```

Refer to:
- `docs/contracts/API_CONTRACT.md` (643 lines)
- `docs/architecture/CNC_CALCULATOR_V4_FINAL_ARCHITECTURE_CONSOLIDATED.md` (sections 4.4-4.7)

Estimated time: 12-16 hours

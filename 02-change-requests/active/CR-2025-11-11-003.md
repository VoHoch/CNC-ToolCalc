# Change Request: Phase 1 - Backend API Setup & Foundation

**CR-ID:** CR-2025-11-11-003
**Version:** v0.0.1-alpha â†’ v0.1.0-alpha
**Agent:** backend-calculation
**Status:** DRAFT
**Created:** 2025-11-11
**Updated:** 2025-11-11

---

## Summary

Set up the FastAPI backend project with Pydantic models, basic API endpoints (health, materials, operations), and testing infrastructure. Prepare for 10-phase calculation engine implementation.

---

## Type

- [x] Feature (new functionality)
- [ ] Enhancement
- [ ] Bug Fix
- [ ] Refactoring
- [ ] Documentation
- [ ] Test

---

## Motivation

Phase 1 requires a working backend API that:
1. Serves static data (materials, operations)
2. Validates requests with Pydantic
3. Follows API Contract specifications exactly
4. Has testing infrastructure ready
5. Prepares foundation for calculation engine (Phase 2)

This CR establishes the backend foundation for all calculation work.

---

## Detailed Description

### 1. FastAPI Project Structure
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                 # FastAPI app + CORS
â”‚   â”œâ”€â”€ config.py               # Configuration
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ tool.py             # Tool, ToolGeometry
â”‚   â”‚   â”œâ”€â”€ material.py         # Material, MaterialType
â”‚   â”‚   â”œâ”€â”€ operation.py        # Operation, OperationType
â”‚   â”‚   â”œâ”€â”€ calculation.py      # CalculationRequest, Response
â”‚   â”‚   â””â”€â”€ enums.py            # CoatingType, SurfaceQuality, etc.
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ health.py       # Health check endpoint
â”‚   â”‚   â”‚   â”œâ”€â”€ materials.py    # GET /api/materials
â”‚   â”‚   â”‚   â””â”€â”€ operations.py   # GET /api/operations
â”‚   â”‚   â””â”€â”€ dependencies.py     # Dependency injection
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ material_service.py # Material data service
â”‚   â”‚   â””â”€â”€ operation_service.py # Operation data service
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ validation.py       # Custom validators
â”‚       â””â”€â”€ errors.py           # Error handling
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py             # Pytest fixtures
â”‚   â”œâ”€â”€ test_health.py
â”‚   â”œâ”€â”€ test_materials.py
â”‚   â””â”€â”€ test_operations.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ requirements-dev.txt
â””â”€â”€ pytest.ini
```

### 2. Pydantic Models
Create complete type definitions matching API Contract:

**Tool Models:**
```python
class ToolGeometry(BaseModel):
    DC: float = Field(gt=0, description="Cutting diameter [mm]")
    LCF: float = Field(gt=0, description="Cutting length [mm]")
    DCON: float = Field(gt=0, description="Connection diameter [mm]")
    OAL: float = Field(gt=0, description="Overall length [mm]")
    NOF: int = Field(ge=1, description="Number of flutes")

class Tool(BaseModel):
    id: str
    name: str
    type: str
    geometry: ToolGeometry
    ld_ratio: float
    ld_classification: Literal["short", "normal", "long", "very_long"]
```

**Material Models:**
```python
class MaterialType(str, Enum):
    SOFTWOOD = "softwood"
    HARDWOOD = "hardwood"
    ACRYLIC = "acrylic"
    ALUMINIUM = "aluminium"
    BRASS = "brass"
    STEEL_MILD = "steel_mild"
    STEEL_STAINLESS = "steel_stainless"

class Material(BaseModel):
    id: str
    name: str
    hardness_order: int
    color: str
    category: Literal["wood", "metal", "plastic"]
    properties: MaterialProperties  # For Phase 2
```

**Operation Models:**
```python
class OperationType(str, Enum):
    FACE_ROUGH = "FACE_ROUGH"
    FACE_FINISH = "FACE_FINISH"
    SLOT_ROUGH = "SLOT_ROUGH"
    SLOT_FINISH = "SLOT_FINISH"
    SLOT_FULL = "SLOT_FULL"
    SLOT_TROCHOIDAL = "SLOT_TROCHOIDAL"  # â­ NEW
    # ... 7 more operations

class Operation(BaseModel):
    id: str
    name: str
    description: str
    category: Literal["FACE", "SLOT", "GEOMETRY", "SPECIAL"]
    typical_ae_range: str
    typical_ap_range: str
    color: str
```

**Calculation Models (placeholders for Phase 2):**
```python
class CalculationRequest(BaseModel):
    tool: Tool
    operation: OperationType
    coating: CoatingType
    surface_quality: SurfaceQuality
    coolant: CoolantType
    expert_mode: Optional[ExpertModeConfig] = None

class CalculationResponse(BaseModel):
    results: CalculationResults
    warnings: List[Warning]
    metadata: CalculationMetadata
```

### 3. API Endpoints (Phase 1 - Basic)

**GET /health**
```python
@router.get("/health")
async def health_check():
    return {
        "status": "ok",
        "version": "0.1.0-alpha",
        "timestamp": datetime.now().isoformat()
    }
```

**GET /api/materials**
```python
@router.get("/api/materials")
async def get_materials() -> MaterialsResponse:
    # Returns 7 materials sorted by hardness
    return MaterialService.get_all_materials()
```

**GET /api/operations**
```python
@router.get("/api/operations")
async def get_operations() -> OperationsResponse:
    # Returns 13 operations grouped by category
    return OperationService.get_all_operations()
```

**POST /api/calculate** (Phase 2)
- Placeholder for now
- Returns 501 Not Implemented

### 4. Material & Operation Data Services
Hardcode material/operation data based on architecture specs:

**Material Data:**
```python
MATERIALS = [
    Material(
        id="softwood",
        name="Softwood (Weichholz)",
        hardness_order=1,
        color="#f4e4c1",
        category="wood",
        properties=MaterialProperties(
            hardness_hb=20,
            kc=40,
            vc_base=1000,
            # ...
        )
    ),
    # ... 6 more materials
]
```

**Operation Data:**
```python
OPERATIONS = [
    Operation(
        id="FACE_ROUGH",
        name="Face Milling (Roughing)",
        description="High MRR, coarse surface finish",
        category="FACE",
        typical_ae_range="70-100% DC",
        typical_ap_range="DC/2 to DC",
        color="#fb923c"
    ),
    # ... 12 more operations (including SLOT_TROCHOIDAL)
]
```

### 5. Testing Infrastructure
- Pytest configuration
- Fixtures for test data
- Test client for FastAPI
- Coverage reporting (pytest-cov)

---

## Implementation Details

### Files Created (NEW)

**Backend Core:**
```
backend/app/
â”œâ”€â”€ main.py                     (80 lines)
â”œâ”€â”€ config.py                   (40 lines)
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ tool.py                 (100 lines)
â”‚   â”œâ”€â”€ material.py             (120 lines)
â”‚   â”œâ”€â”€ operation.py            (100 lines)
â”‚   â”œâ”€â”€ calculation.py          (200 lines - partial)
â”‚   â””â”€â”€ enums.py                (150 lines)
â”œâ”€â”€ api/routes/
â”‚   â”œâ”€â”€ health.py               (30 lines)
â”‚   â”œâ”€â”€ materials.py            (50 lines)
â”‚   â””â”€â”€ operations.py           (50 lines)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ material_service.py     (300 lines - data + logic)
â”‚   â””â”€â”€ operation_service.py    (250 lines - data + logic)
â””â”€â”€ utils/
    â”œâ”€â”€ validation.py           (100 lines)
    â””â”€â”€ errors.py               (80 lines)
```

**Tests:**
```
backend/tests/
â”œâ”€â”€ conftest.py                 (50 lines)
â”œâ”€â”€ test_health.py              (30 lines)
â”œâ”€â”€ test_materials.py           (80 lines)
â”œâ”€â”€ test_operations.py          (80 lines)
â””â”€â”€ test_models.py              (100 lines)
```

**Total Estimated Lines:** ~2,000 lines

### Dependencies

**backend/requirements.txt:**
```
fastapi==0.108.0
uvicorn[standard]==0.25.0
pydantic==2.5.0
python-multipart==0.0.6
python-dotenv==1.0.0
sqlalchemy==2.0.23
```

**backend/requirements-dev.txt:**
```
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0
httpx==0.25.2
black==23.12.0
ruff==0.1.8
alembic==1.13.0
```

---

## Architecture Compliance

- [x] Follows Cleanroom principle (NO V2.0 engine code)
- [x] Implements API Contract specifications EXACTLY
  - Reference: `docs/contracts/API_CONTRACT.md` (643 lines)
- [x] **SQLite for Tool Library** âœ“ (UPDATED 2025-11-10)
  - Tool storage: `backend/data/tools.db`
  - Schema: Tools, Presets
- [x] **NO Database for Materials/Operations** (hardcoded in code)
- [x] **NO Database for Calculations** (in-memory only)
- [x] NO Redis (no caching layer needed)
- [x] Type safety: 100% Pydantic models
- [x] Error responses match API Contract format

**Critical Architecture Decisions:**
1. **SQLite for Tool Library ONLY** - Tools & Presets persistent
2. **Materials/Operations** - Hardcoded (Python data structures)
3. **Calculations** - In-memory (not persisted)
4. **ae/ap NOT parametric** - Calculated values, not exported
5. **13 Operations** - Including SLOT_TROCHOIDAL
6. **7 Materials** - Sorted by hardness

---

## Testing

### Unit Tests
- [ ] Material models: 15 tests (validation, serialization)
- [ ] Operation models: 15 tests (validation, enums)
- [ ] Tool models: 20 tests (L/D calculation, validation)
- [ ] Health endpoint: 5 tests
- [ ] Materials endpoint: 10 tests (ordering, response format)
- [ ] Operations endpoint: 10 tests (grouping, response format)
- [ ] **Total:** 75 tests
- [ ] **Coverage Target:** >90%

### Integration Tests
- [ ] FastAPI test client requests
- [ ] CORS configuration
- [ ] Error response format

### Smoke Test
```bash
#!/bin/bash
# Smoke Test: Backend Foundation

echo "ðŸ§ª Starting Smoke Test: CR-2025-11-11-003"

# Install dependencies
pip install -r backend/requirements.txt || exit 1

# Start backend
cd backend
uvicorn app.main:app --host 127.0.0.1 --port 8000 &
BACKEND_PID=$!
sleep 3

# Test health endpoint
curl -f http://127.0.0.1:8000/health || exit 1

# Test materials endpoint
curl -f http://127.0.0.1:8000/api/materials || exit 1

# Test operations endpoint
curl -f http://127.0.0.1:8000/api/operations || exit 1

# Kill backend
kill $BACKEND_PID

# Run unit tests
pytest || exit 1

echo "âœ… Smoke Test PASSED"
```

**Smoke Test Script:** `scripts/smoke-test-cr-003.sh`

---

## Quality Audit

### Code Quality
- [ ] Type safety: 100% (Pydantic)
- [ ] Linter (Ruff): 0 errors
- [ ] Black: Code formatted
- [ ] No code duplication >10 lines
- [ ] Function complexity <15

### Performance
- [ ] Health endpoint: <10ms
- [ ] Materials endpoint: <20ms
- [ ] Operations endpoint: <20ms
- [ ] Startup time: <3s

### Security
- [ ] Input validation: Pydantic âœ“
- [ ] CORS configured properly
- [ ] No secrets in code (env vars)
- [ ] Error messages don't leak internals

---

## User Acceptance Test (UAT)

**UAT Test Plan:**
1. Start backend: `uvicorn app.main:app --reload`
2. Test health endpoint:
   ```bash
   curl http://localhost:8000/health
   # Expected: {"status": "ok", "version": "0.1.0-alpha", ...}
   ```
3. Test materials endpoint:
   ```bash
   curl http://localhost:8000/api/materials
   # Expected: 7 materials, sorted by hardness (softwood first)
   ```
4. Test operations endpoint:
   ```bash
   curl http://localhost:8000/api/operations
   # Expected: 13 operations, 4 groups (FACE, SLOT, GEOMETRY, SPECIAL)
   # SLOT group must include SLOT_TROCHOIDAL âœ“
   ```
5. Test API docs:
   - Open `http://localhost:8000/docs`
   - Verify all endpoints documented âœ“
   - Try "Try it out" feature âœ“
6. Test CORS:
   - Frontend (localhost:5173) can call backend âœ“

**UAT Results:**
- [ ] UAT completed by: [User Name]
- [ ] UAT date: YYYY-MM-DD
- [ ] UAT status: [PASSED / FAILED]

---

## Rollback Plan

```bash
# Revert changes
git revert <commit-hash>

# OR restore from backup
git checkout v0.0.1-alpha -- backend/
```

---

## Related Change Requests

- **Related:** CR-2025-11-11-002 (Frontend must match API types)
- **Blocks:** Phase 2 calculation engine implementation
- **Depends on:** API Contract (`docs/contracts/API_CONTRACT.md`)

---

## Approval

- [ ] Agent self-review completed
- [ ] Governance Agent review completed
- [ ] Smoke test passed
- [ ] UAT passed
- [ ] Ready for merge

**Approved by:** [Pending]
**Date:** [Pending]

---

## Post-Merge

- [ ] Merged to `agent/backend-calculation`
- [ ] Governance reviewed
- [ ] Quality Gate 1 passed
- [ ] Tagged: `v0.1.0-alpha` (after all Phase 1 CRs)
- [ ] Documentation updated

---

## Agent Notes

**Critical Requirements:**
1. **NO Database** - All data in-memory (Python lists/dicts)
2. **NO V2.0 Engine** - Cleanroom implementation
3. **API Contract EXACT match** - Frontend depends on exact types
4. **13 Operations** - Must include SLOT_TROCHOIDAL
5. **7 Materials** - Hardness-sorted

**Material Properties (for Phase 2):**
```python
class MaterialProperties(BaseModel):
    hardness_hb: float          # Brinell hardness
    kc: float                   # Specific cutting force [N/mmÂ²]
    vc_base: float              # Base cutting speed [m/min]
    dry_factor: float           # Dry machining reduction (0.65-1.0)
    max_temp_c: float           # Max chip temperature [Â°C]
    k_thermal: float            # Thermal conductivity factor
```

**Operation ae/ap Factors (for Phase 2):**
```python
class OperationParameters(BaseModel):
    ae_factor: float            # Radial engagement factor (0.05-1.0)
    ap_factor: float            # Axial depth factor (0.10-0.50)
    ap_reference: Literal["DC", "LCF", "dynamic"]
```

**SLOT_TROCHOIDAL Special Parameters:**
```python
# ae_factor: 0.10 (only 10% DC - small circular increments)
# ap_factor: 0.50 (full depth possible)
# ap_reference: "LCF" (uses full cutting length)
```

Refer to:
- `docs/contracts/API_CONTRACT.md` (643 lines)
- `docs/architecture/CNC_CALCULATOR_V4_FINAL_ARCHITECTURE_CONSOLIDATED.md` (Part 2 & 3)

Estimated time: 14-18 hours
